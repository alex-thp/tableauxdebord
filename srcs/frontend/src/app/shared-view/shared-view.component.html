<div *ngIf="filteredResult.length > 0; else noData" class="table-container">
  <table class="styled-table">
    <thead>
      <tr>
        <!-- Groupe 1 -->
        <th colspan="3" class="header group1">Données personnelles</th>
        <!-- Groupe 2 -->
        <th colspan="6" class="header group2">Contexte social</th>
        <!-- Groupe 3 -->
        <th colspan="4" class="header group3">Atelier</th>
        <!-- Groupe 4 -->
        <th colspan="3" class="header group4">Satisfaction & Projet</th>
      </tr>
      <tr>
        <!-- Groupe 1 -->
        <th
          class="label group1"
          (click)="toggleFilter('candidat_genre')"
          [class.filter-open]="filterOpenForKey === 'candidat_genre'"
        >
          Genre
        </th>
        <th
          class="label group1"
          (click)="toggleFilter('candidat_age')"
          [class.filter-open]="filterOpenForKey === 'candidat_age'"
        >
          Âge
        </th>
        <th
          class="label group1"
          (click)="toggleFilter('candidat_code_postal')"
          [class.filter-open]="filterOpenForKey === 'candidat_code_postal'"
        >
          Code postal
        </th>

        <!-- Groupe 2 -->
        <th
          class="label group2"
          (click)="toggleFilter('qpv')"
          [class.filter-open]="filterOpenForKey === 'qpv'"
        >
          QPV
        </th>
        <th
          class="label group2"
          (click)="toggleFilter('epa')"
          [class.filter-open]="filterOpenForKey === 'epa'"
        >
          EPA
        </th>
        <th
          class="label group2"
          (click)="toggleFilter('aide_sociale')"
          [class.filter-open]="filterOpenForKey === 'aide_sociale'"
        >
          Aide sociale
        </th>
        <th
          class="label group2"
          (click)="toggleFilter('sous_main_justice')"
          [class.filter-open]="filterOpenForKey === 'sous_main_justice'"
        >
          Sous main justice
        </th>
        <th
          class="label group2"
          (click)="toggleFilter('rqth')"
          [class.filter-open]="filterOpenForKey === 'rqth'"
        >
          RQTH
        </th>
        <th
          class="label group2"
          (click)="toggleFilter('orphelin')"
          [class.filter-open]="filterOpenForKey === 'orphelin'"
        >
          Orphelin
        </th>

        <!-- Groupe 3 -->
        <th
          class="label group3"
          (click)="toggleFilter('statut')"
          [class.filter-open]="filterOpenForKey === 'statut'"
        >
          Statut
        </th>
        <th
          class="label group3"
          (click)="toggleFilter('date_atelier')"
          [class.filter-open]="filterOpenForKey === 'date_atelier'"
        >
          Date atelier
        </th>
        <th
          class="label group3"
          (click)="toggleFilter('atelier_lieu')"
          [class.filter-open]="filterOpenForKey === 'atelier_lieu'"
        >
          Lieu atelier
        </th>
        <th
          class="label group3"
          (click)="toggleFilter('type_atelier')"
          [class.filter-open]="filterOpenForKey === 'type_atelier'"
        >
          Type atelier
        </th>

        <!-- Groupe 4 -->
        <th
          class="label group4"
          (click)="toggleFilter('note_satisfaction')"
          [class.filter-open]="filterOpenForKey === 'note_satisfaction'"
        >
          Note satisfaction
        </th>
        <th
          class="label group4"
          (click)="toggleFilter('metier_recherche')"
          [class.filter-open]="filterOpenForKey === 'metier_recherche'"
        >
          Métier recherché
        </th>
        <th
          class="label group4"
          (click)="toggleFilter('secteur_recherche')"
          [class.filter-open]="filterOpenForKey === 'secteur_recherche'"
        >
          Secteur recherché
        </th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let row of filteredResult">
        <!-- Groupe 1 -->
        <td class="group1">{{ row['candidat_genre'] }}</td>
        <td class="group1">{{ row['candidat_age'].toFixed(0) }}</td>
        <td class="group1">{{ row['candidat_code_postal'] }}</td>

        <!-- Groupe 2 -->
        <td class="group2">{{ row['qpv'] }}</td>
        <td class="group2">{{ row['epa'] }}</td>
        <td class="group2">{{ row['aide_sociale'] }}</td>
        <td class="group2">{{ row['sous_main_justice'] }}</td>
        <td class="group2">{{ row['rqth'] }}</td>
        <td class="group2">{{ row['orphelin'] }}</td>

        <!-- Groupe 3 -->
        <td class="group3">{{ row['statut'] }}</td>
        <td class="group3">{{ row['date_atelier'] | date: 'dd/MM/yyyy' }}</td>
        <td class="group3">{{ row['atelier_lieu'] }}</td>
        <td class="group3">{{ row['type_atelier'] }}</td>

        <!-- Groupe 4 -->
        <td class="group4">{{ row['note_satisfaction'] }}</td>
        <td class="group4">{{ row['metier_recherche'] }}</td>
        <td class="group4">{{ row['secteur_recherche'] }}</td>
      </tr>
    </tbody>
  </table>

  <div
    class="filter-popup"
    *ngIf="filterOpenForKey"
    [style.top.px]="filterPopupPosition.top"
    [style.left.px]="filterPopupPosition.left"
  >
    <div class="filter-header" (mousedown)="startDrag($event)">
      <strong>Filtres pour : {{ filterOpenForKey }}</strong>
      <button (click)="closeFilters()" class="close-btn">×</button>
    </div>

    <div *ngIf="isDateField(filterOpenForKey); else normalFilter" class="date-filter-container">
      <label>
        Antérieur à :
        <input
          type="date"
          [value]="selectedFilters[filterOpenForKey]?.max || ''"
          (change)="onDateFilterChange(filterOpenForKey, 'max', $event)"
        />
      </label>
      <label>
        Ultérieur à :
        <input
          type="date"
          [value]="selectedFilters[filterOpenForKey]?.min || ''"
          (change)="onDateFilterChange(filterOpenForKey, 'min', $event)"
        />
      </label>
    </div>

    <ng-template #normalFilter>
      <div *ngFor="let option of filterValues[filterOpenForKey]">
        <input
          type="checkbox"
          [name]="filterOpenForKey"
          [value]="option"
          (change)="applyFilter(filterOpenForKey, option)"
          [checked]="selectedFilters[filterOpenForKey]?.includes(option)"
        />
        {{ option }}
      </div>
    </ng-template>

    <!-- Bouton Réinitialiser -->
    <button (click)="resetFilter(filterOpenForKey)" class="reset-btn">
      Réinitialiser le filtre
    </button>

    <button (click)="closeFilters()" class="apply-btn">Appliquer</button>
  </div>
</div>

<ng-template #noData>
  <p>Chargement des données, veuillez patienter...</p>
</ng-template>

<div class="row-count-fixed">
  Nombre de lignes: {{ filteredResult.length }}
</div>
